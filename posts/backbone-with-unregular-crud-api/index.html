<!doctype html> <html lang=zh-CN> <head> <title>Teddy Ma's Homepage | </title> <meta content="IE=edge" http-equiv=X-UA-Compatible> <meta charset=utf-8> <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name=viewport> <meta name=author content="Teddy Ma"> <meta name=description content="Teddy Ma's Personal Website"> <meta name=keywords content="programming, software engineer, code"> <link rel=stylesheet href="https://www.songofcode.com/socss/assets/toolkit/styles/toolkit.css"/> <!--[if lt IE 9]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--> <script>
window['_fs_debug'] = false;
window['_fs_host'] = 'fullstory.com';
window['_fs_org'] = 'MP5K7';
window['_fs_namespace'] = 'FS';
(function(m,n,e,t,l,o,g,y){
    if (e in m) {if(m.console && m.console.log) { m.console.log('FullStory namespace conflict. Please set window["_fs_namespace"].');} return;}
    g=m[e]=function(a,b,s){g.q?g.q.push([a,b,s]):g._api(a,b,s);};g.q=[];
    o=n.createElement(t);o.async=1;o.crossOrigin='anonymous';o.src='https://'+_fs_host+'/s/fs.js';
    y=n.getElementsByTagName(t)[0];y.parentNode.insertBefore(o,y);
    g.identify=function(i,v,s){g(l,{uid:i},s);if(v)g(l,v,s)};g.setUserVars=function(v,s){g(l,v,s)};g.event=function(i,v,s){g('event',{n:i,p:v},s)};
    g.shutdown=function(){g("rec",!1)};g.restart=function(){g("rec",!0)};
    g.log = function(a,b) { g("log", [a,b]) };
    g.consent=function(a){g("consent",!arguments.length||a)};
    g.identifyAccount=function(i,v){o='account';v=v||{};v.acctId=i;g(o,v)};
    g.clearUserCookie=function(){};
})(window,document,window['_fs_namespace'],'script','user');
</script> <link href="/assets/stylesheets/highlightjs/a11y-light-3f5cde8e.css" rel=stylesheet /> </head> <body class="posts posts_backbone-with-unregular-crud-api posts_backbone-with-unregular-crud-api_index typo"> <article> <h1>当 Backbone.js 遇上非 CRUD API</h1> <p>最近使用 Backbone.js 开发客户端时发现了一个看似很小，实则非常麻烦的问题：</p> <p><code>如何与非 CRUD 式的 RESTFul API 交互。</code></p> <p>举个例子，有一个活动 activity 模型，它可以被开启或者停止，有两种解决方案：</p> <ol> <li>使用 put 或者 patch，比如 <code>/service/activities/:id</code> 并传递参数 <code>{status: :active}</code></li> <li>使用额外的 endpoint, 比如 <code>/service/activities/:id/active</code></li> </ol> <p>如果使用第一种方式，那么就是标准的 CRUD 式的 API，Backbone.js 默认就支持。</p> <p>但是实际上开启一个活动是一个比较大的动作，可能需要调用其他模块的功能，并不是简单的改一个字段。</p> <p>因此从 api 设计的角度我是倾向于使用第二种方式的。可是奇怪的是关于 Backbone.js 调用 CRUD 以外 的 API 的文章非常少，</p> <p>我翻遍 google 就勉强找到了<a href="http://www.veriday.com/let-backbone-slide-extending-restful-web-services/">这篇</a>。通过临时改变 model 的 url 属性来实现的。 并没有太让我满意。</p> <p>正好晚上向 <a href="https://ruby-china.org/vincent">vincent</a> 请教了一下这个问题，因为讨论的重点是 api 设计而不是 backbone 的具体实现，反而开阔了我的思路。</p> <p>重新复习了一下 RESTful 的相关知识，发现了一个常见误区：</p> <blockquote> <p>最常见的一种设计错误，就是URI包含动词。因为&#8221;资源&#8221;表示一种实体，所以应该是名词，URI不应该有动词，动词应该放在HTTP协议中。</p> </blockquote> <p>对于这个观点争论不少，毕竟类似于 <code>/service/activities/:id/active</code> 这样的设计还是很常见的。 这个 AOE 范围有点大。。。<a href="http://stackoverflow.com/questions/2001773/understanding-rest-verbs-error-codes-and-authentication">stackoverflow上有个讨论可以参考</a>。</p> <p>其中我比较赞同的一点是：</p> <blockquote> <p>In general, when you think you need more verbs, it may actually mean that your resources need to be re-identified.</p> </blockquote> <p>另外， <a href="http://www.vinaysahni.com/best-practices-for-a-pragmatic-restful-api#restful">这里</a> 提出的三种解决方案也可以参考。</p> <p>举个例子：</p> <p><img src="assets/images/restful-api-book-print-934e04a6.png" alt="assets/images/restful-api-book-print-934e04a6.png"/></p> <p>你是想打印一本书，还是发起一个打印的订单请求？</p> <p>一样的道理，我是要激活一个活动，还是发起一个激活活动的请求？</p> <p>这个例子中，使用了名词代替动词。一旦变成了名词，我立马想到可以新建一个 model。</p> <p>这下，只要创建一个 Backbone.js 的模型 <code>startActivity</code>, 然后把它的 url 指向 <code>/service/activities/:id/start_active</code></p> <p>或者 <code>/service/activities/:id/activation</code> 这样的名词形式的 url 就行了。</p> <p>当发起请求后（激活由于业务逻辑的限制，未必就会成功），后续的逻辑就可以都放在这个 <code>startActivity</code> 对象中。</p> <p>如果激活失败就显示错误信息，成功则通知 <code>activity</code> 模型重新渲染自己的视图。</p> <p>这样结构更加清晰。这未必是最好的解决方案，但是不失为一种不错的思路。</p> <p>这次我犯的错误是：</p> <ul> <li>一开始总是从 Backbone.js 的方面找问题。想要把 Backbone.js 变成一把锤子来解决这个钉子。</li> <li>对 RESTFul 这样的概念理解还是不够，否则思路也不会这么局限。</li> </ul> </article> <script src="/assets/javascripts/all-70879c36.js"></script> <script src="/assets/javascripts/highlight-e7667caa.js"></script> <script>hljs.initHighlightingOnLoad()</script> <div id=github-comments></div> <script src="/assets/javascripts/comment-ddc93c2f.js" id=github-comment data-ssl=true data-theme=green data-username=teddy-ma data-repo="teddy-ma.github.io" data-page-id="posts/backbone-with-unregular-crud-api"></script> </body> </html>