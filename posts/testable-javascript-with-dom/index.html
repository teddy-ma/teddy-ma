<!doctype html>
<html lang="zh-cmn-Hans" class="han-init">
  <head>
    <meta charset="utf-8">
    <title>编程青年 - 测试包含 DOM 操作的 JavaScript 代码</title>
    <meta name="description" content="编程青年的博客，记录着软件开发中的点点滴滴">
    <meta name="copyright" content="Ma Lucheng 2014-2015">
    <meta name="generator" content="pandoc">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <link href="/css/app.css" rel="stylesheet">
    <link href="//cdn.bootcss.com/highlight.js/8.9.1/styles/solarized_light.min.css" rel="stylesheet">
  </head>

  <body class="container">
    <header class="global-header row">
      <h1 class="global-header__logo four columns"><a href="/" class="blog-title-link">编程青年</a></h1>
      <nav id="menu1" class="navbar eight columns">
        <ul class="navbar-list">
          
            <li class="navbar-item">
              <a href="/posts/" class="navbar-link" target='_self'>posts</a>
            </li>
          
            <li class="navbar-item">
              <a href="/essays/" class="navbar-link" target='_self'>essays</a>
            </li>
          
            <li class="navbar-item">
              <a href="/reading/" class="navbar-link" target='_self'>reading</a>
            </li>
          
            <li class="navbar-item">
              <a href="http://songofcode.com/how-to-learn-emacs-chinese-edition/" class="navbar-link" target='_blank'>emacs</a>
            </li>
          
            <li class="navbar-item">
              <a href="/about/" class="navbar-link" target='_self'>about</a>
            </li>
          
            <li class="navbar-item">
              <a href="https://github.com/teddy-ma/" class="navbar-link" target='_blank'>github</a>
            </li>
          
        </ul>
      </nav>
      <nav id="menu2" class="path-nav path-nav-top-right">
        <a href="#menu2" class="path-nav-expander">
          <div class="ball"></div>
        </a>
        <a href="#" class="path-nav-close"></a>
        <ul>
          
            <li>
              <a href="/posts/" target='_self'>posts</a>
            </li>
          
            <li>
              <a href="/essays/" target='_self'>essays</a>
            </li>
          
            <li>
              <a href="/reading/" target='_self'>reading</a>
            </li>
          
            <li>
              <a href="http://songofcode.com/how-to-learn-emacs-chinese-edition/" target='_blank'>emacs</a>
            </li>
          
            <li>
              <a href="/about/" target='_self'>about</a>
            </li>
          
            <li>
              <a href="https://github.com/teddy-ma/" target='_blank'>github</a>
            </li>
          
        </ul>
      </nav>
    </header>

    <main id="baseline" role="main" class="page-main typo yue row">
      <div class="section typeset twelve columns">
        <!-- 文章视图 -->
<article>
  <h1 id="测试包含-dom-操作的-javascript-代码">测试包含 DOM 操作的 JavaScript 代码</h1>
<p>关于各类编程语言的单元测试大家都不陌生了，不过说起给网页 ui 做测试就不那么常见了。 正好我最近写了一段简单的js代码。 觉得是挺好的学习的例子。在这里分享一下。</p>
<h2 id="需求">需求</h2>
<p>我使用 hakyll(现改为gulp) 作为自己的静态网站建站工具，它使用 pandoc 这把格式转换的瑞士军刀作为格式转换工具。 而我会使用 org-mode 来写文档（包含slides）。虽然 pandoc 支持 org-mode，但是要直接用 pandoc 把 org-mode 转成 slides，官方的支持还是不够好，于是我打算自己稍微 hack 一下来实现。</p>
<h2 id="步骤">步骤</h2>
<p>由于 pandoc 可以把 org-mode 转成 html，org-mode 的星号层级就对应 h1-h6。 然后转换的时候又可以指定 template， 正巧我发现 <a href="https://github.com/hakimel/reveal.js">revealjs</a> 发布了3.0版， 和2.x版有不兼容的地方（很多转换工具的 revealjs 的官方模板还是 2.x的。 于是就决定选用 revealjs 的 3.0 版本作为 template。 观察一下 revealjs 的html结构不难发现。每个 slide 都是一个 section 标签，非常简洁。 至于 revealjs 的一大特色 “VERTICAL SLIDES”， 则需要每个垂直的 slide 都有一个自己的 section 标签包裹（包括第一张 slide）， 然后在横座标上有一个大的 section 包裹。这样 需求就很明确了，我要把 pandoc 转成的最朴素的 html 结构用 js 包裹那么几层来适配 revealjs。 如下图：</p>
<p>左侧是 pandoc 生成的朴素html， 右侧的框代表需要嵌套的 section 标签</p>
<p><img src="http://javaer.qiniudn.com/assets/posts/images/test-js/compare.png" alt="" /></p>
<p>实现了上面的html结构后， 生成的 slides 就会是这样：</p>
<p><img src="http://javaer.qiniudn.com/assets/posts/images/test-js/result.png" alt="" /></p>
<p>功能不复杂，稍微会点 jquery 的话几行代码就搞定了</p>
<h2 id="思路">思路</h2>
<p>经过短暂的尝试， 我决定使用一些“辅助线”。在每个需要分隔的地方（就是 h1 - h3 的标签上）的上方插入一条辅助用的 hr 标签。 然后遍历整个 dom，以标题标签为起点，辅助线为终点划分dom元素，然后用 section 包裹起来。代码如下：</p>
<pre class="javascript"><code>function revealjs_convert(){
  add_separator();
  add_top_wrapper();
  add_first_wrapper();
  cleanup();
};

function add_separator(){
  $(&quot;#main-container&quot;).find(&quot;h1&quot;).before(&#39;&lt;hr class=&quot;separator h1&quot;/&gt;&#39;);
  $(&quot;#main-container&quot;).find(&quot;h2&quot;).before(&#39;&lt;hr class=&quot;separator h2&quot;/&gt;&#39;);
  $(&quot;#main-container&quot;).find(&quot;h3&quot;).before(&#39;&lt;hr class=&quot;separator h3&quot;/&gt;&#39;);
}

function add_top_wrapper(){
  var title_h1 = $(&quot;#main-container&quot;).find(&#39;h1&#39;);
  var blk = title_h1.nextUntil(&#39;hr.separator.h2&#39;).wrapAll(&#39;&lt;section&gt;&lt;/section&gt;&#39;);
  blk.parent().prepend(title_h1);
}

function add_first_wrapper(){
  var title_h2s = $(&quot;#main-container&quot;).find(&#39;h2&#39;);
  title_h2s.each(function(){
    var blk = $(this).nextUntil(&#39;hr.separator.h2&#39;).wrapAll(&#39;&lt;section&gt;&lt;/section&gt;&#39;);
    blk.parent().prepend(this);
    if(blk.parent().find(&#39;h2&#39;).length &gt; 0 &amp;&amp; blk.parent().find(&#39;h3&#39;).length &gt; 0){ //有子模块
        var blk_h2 = blk.parent().find(&#39;h2&#39;)
        var top_blk = blk_h2.nextUntil(&#39;hr.separator.h3&#39;).wrapAll(&#39;&lt;section&gt;&lt;/section&gt;&#39;);
        top_blk.parent().prepend(blk_h2);
        // 循环 h3
        blk.parent().find(&#39;h3&#39;).each(function(){
            var sub_blk = $(this).nextUntil(&#39;hr.separator.h3&#39;).wrapAll(&#39;&lt;section&gt;&lt;/section&gt;&#39;);
            sub_blk.parent().prepend($(this));
        });
    }
  });
}

function cleanup(){
  $(&quot;#main-container&quot;).find(&quot;li&quot;).addClass(&quot;fragment&quot;);
  $(&quot;hr.separator&quot;).remove();
}
</code></pre>
<p>虽然很丑， 但是 It works!</p>
<p>在这段代码生效后再调用 revealjs 的启动代码就 ok 了。 好了，本来一段挺简单的脚本。它完成了工作，让我用 org-mode 写的大纲变成了 slides。 通常这就是一段 JavaScript 代码的最终命运了。 但是我们没有编写任何测试的代码。所以还不能结束。</p>
<h2 id="使用测试工具">使用测试工具</h2>
<p>JavaScript 也是一门编程语言，自然不少测试工具，常见的测试工具有：</p>
<ul>
<li>Mocha</li>
<li>Chai</li>
<li>Sinon</li>
</ul>
<p>这类类似 xUnit 这样的单元测试工具。</p>
<p>也有</p>
<ul>
<li>webdriver</li>
<li>PhantomJS</li>
</ul>
<p>这样的集成测试工具。 webdriver 就是一个浏览器的驱动程序，它提供接口给开发者，使之可以编写代码操作浏览器。 而 PhantomJS 干脆就是一个无界面的 webkit 实现，相对而言性能更高，适合开发者使用。</p>
<h2 id="编写测试">编写测试</h2>
<p>这里我就简单的使用 Chai 和 Mocha 来编写测试了。 刚才说了大段的流程，其实一点也不复杂，复杂的部分 pandoc 和 revealjs 都做了。 我要测的部分仅仅是生成符合 revealjs 规范的 html 结构而已。</p>
<p><a href="http://javaer.me/demo/test-js-with-dom/">这里</a> 有一个 demo，我直接贴测试代码了：</p>
<pre class="javascript"><code>describe(&#39;revealjs should work&#39;, function(){
  // 预期的结果是，#main-container 外层有4个 section
  // 其中第三个 section 中又有3个 section
  it(&#39;has four outside section&#39;, function(){
      var number = $(&quot;#main-container&quot;).children(&quot;section&quot;).length;
      expect(number).to.equal(4);
  });

  it(&#39;has three inner section in the third section&#39;, function(){
      var number = $(&quot;#main-container&quot;).children(&quot;section&quot;)
                     .eq(2).children(&quot;section&quot;).length;
      expect(number).to.equal(3);
  });
});
</code></pre>
<p>这个页面结构很简单，直接打开 demo 看源码注释很容易理解。</p>
<h2 id="重构">重构</h2>
<p>有了测试做保障，我们就可以放心的重构代码了。结果如下：</p>
<pre class="javascript"><code>var container;

function revealjs_adapter(ctn){
  if(ctn == undefined){
      container=&quot;#main-container&quot;;
  }else {
      container = ctn;
  }

  $(container).append(&#39;&lt;hr class=&quot;separator horizontal&quot;&gt;&#39;);

  add_helper_line([&#39;h1&#39;,&#39;h2&#39;,&#39;h3&#39;]);

  wrap_horizontal();
  wrap_vertical();

  cleanup();
}

function add_helper_line(heads){
    heads.forEach(function(head){
        var titles = $(container).find(head);
        titles.each(function(){ //head 上方辅助线
            $(this).before(separator(this));
        });
    });
}

function wrap_horizontal(){
  $(&quot;hr.separator.horizontal&quot;).each(function(){
    $(this).nextUntil(&#39;hr.separator.horizontal&#39;).wrapAll(&#39;&lt;section&gt;&lt;/section&gt;&#39;);
  });
}

function wrap_vertical(){
  $(container).find(&quot;section:has(.vertical)&quot;).prepend(&quot;&lt;hr class=&#39;separator vertical&#39; /&gt;&quot;);
  // 原本的 h2 块需要重新套一层
  $(&quot;hr.separator.vertical&quot;).each(function(){
      $(this).nextUntil(&#39;hr.separator&#39;).wrapAll(&#39;&lt;section&gt;&lt;/section&gt;&#39;);
  });
}

function cleanup(){
  $(container).find(&quot;li&quot;).addClass(&quot;fragment&quot;); // 让列表可以 one by one 的显示，和主逻辑无关
  $(&quot;hr.separator&quot;).remove();
  $(&quot;section:not(:has(*))&quot;).remove();
}

//private

// 生成分割线
function separator(head) {
  var direct = get_direct(head);
  return &#39;&lt;hr class=&quot;separator &#39;+direct+&#39;&quot; /&gt;&#39;;
}

function get_direct(head){
  tag = head.localName;
  if(tag == &quot;h1&quot; || tag == &quot;h2&quot;){
    return &quot;horizontal&quot;;
  }
  if(tag == &quot;h3&quot;){
    return &quot;vertical&quot;;
  }
}
</code></pre>
<p>虽然还有改动空间，不过比上个版本强多了。<a href="http://javaer.me/slides/backbone-and-spa.html">这里</a> 是一个真实的例子。 总之有了单元测试做保护，重构或重写代码就轻松多了。</p>

</article>

      </div>
    </main> <!-- 网页主体 -->

    <!-- 评论框 -->

    <footer role="contentinfo" class="global-footer row">
      <p class="copyright">© Ma Lucheng 2014-2015 — All content is licensed under the
        <a href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons BY-SA 3.0</a>.
      </p>

      <figure class="footer-zfm">
        <img src="http://javaer.qiniudn.com/zhifuma.png" alt="支付宝二维码" />
        <figcaption>觉得文章对你有帮助，可以打赏一杯咖啡支持一下</figcaption>
      </figure>
    </footer><!-- 页脚 -->

    <script src="/js/vendor.js"></script>
    <script src="/js/app.js"></script>
    <script src="//cdn.bootcss.com/highlight.js/8.9.1/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script>require('main').init();</script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-68587267-1', 'auto');
      ga('send', 'pageview');
    </script>

    <script src="//cdn.bootcss.com/instantclick/3.0.1/instantclick.min.js"></script>
    <script>
      InstantClick.on('change', function() {
        var blocks = document.querySelectorAll('pre code');
        for (var i = 0; i < blocks.length; i++) {
          hljs.highlightBlock(blocks[i]);
        }
      });
    </script>

    <script type="text/javascript" src=""></script>
  </body>
</html>
