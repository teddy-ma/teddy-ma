<!doctype html>
<html lang="zh-cmn-Hans" class="han-init">
  <head>
    <meta charset="utf-8">
    <title>编程青年 - 使用 chef 搭建 ruby 开发环境</title>
    <meta name="description" content="编程青年的博客，记录着软件开发中的点点滴滴">
    <meta name="copyright" content="Ma Lucheng 2014-2015">
    <meta name="generator" content="pandoc">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <link href="/css/app.css" rel="stylesheet">
    <link href="//cdn.bootcss.com/highlight.js/8.9.1/styles/solarized_light.min.css" rel="stylesheet">
  </head>

  <body class="container">
    <header class="global-header row">
      <h1 class="global-header__logo four columns"><a href="/" class="blog-title-link">编程青年</a></h1>
      <nav id="menu1" class="navbar eight columns">
        <ul class="navbar-list">
          
            <li class="navbar-item">
              <a href="/posts/" class="navbar-link" target='_self'>posts</a>
            </li>
          
            <li class="navbar-item">
              <a href="/essays/" class="navbar-link" target='_self'>essays</a>
            </li>
          
            <li class="navbar-item">
              <a href="/reading/" class="navbar-link" target='_self'>reading</a>
            </li>
          
            <li class="navbar-item">
              <a href="http://songofcode.com/how-to-learn-emacs-chinese-edition/" class="navbar-link" target='_blank'>emacs</a>
            </li>
          
            <li class="navbar-item">
              <a href="/about/" class="navbar-link" target='_self'>about</a>
            </li>
          
            <li class="navbar-item">
              <a href="https://github.com/teddy-ma/" class="navbar-link" target='_blank'>github</a>
            </li>
          
        </ul>
      </nav>
      <nav id="menu2" class="path-nav path-nav-top-right">
        <a href="#menu2" class="path-nav-expander">
          <div class="ball"></div>
        </a>
        <a href="#" class="path-nav-close"></a>
        <ul>
          
            <li>
              <a href="/posts/" target='_self'>posts</a>
            </li>
          
            <li>
              <a href="/essays/" target='_self'>essays</a>
            </li>
          
            <li>
              <a href="/reading/" target='_self'>reading</a>
            </li>
          
            <li>
              <a href="http://songofcode.com/how-to-learn-emacs-chinese-edition/" target='_blank'>emacs</a>
            </li>
          
            <li>
              <a href="/about/" target='_self'>about</a>
            </li>
          
            <li>
              <a href="https://github.com/teddy-ma/" target='_blank'>github</a>
            </li>
          
        </ul>
      </nav>
    </header>

    <main id="baseline" role="main" class="page-main typo yue row">
      <div class="section typeset twelve columns">
        <!-- 文章视图 -->
<article>
  <h1 id="使用-chef-搭建-ruby-开发环境">使用 chef 搭建 ruby 开发环境</h1>
<p>最近由于硬件升级, 重装了一下工作用的电脑的系统. 当搭建开发环境时, 本来想使用 <a href="https://github.com/thoughtbot/laptop">laptop</a> 这个脚本的, 结果发现这个项目 早就 <a href="https://github.com/thoughtbot/laptop/commit/91048f3f96f0d2d14c1106f746dd51c417a26e30">不支持linux了</a>. 找了一圈发现居然没有好用的配置脚本. 于是决定使用 <a href="http://chef.io/">chef</a> 来自己写一个.</p>
<h2 id="关于-chef">关于 chef</h2>
<p>简单来说就是:</p>
<blockquote>
<p>Chef is a powerful automation platform that transforms complex infrastructure into code</p>
</blockquote>
<p>或者说</p>
<blockquote>
<p>Chef provided an automation solution flexible enough to bend to our scale dynamics without requiring us to change our workflow. -- Phil Dibowitz</p>
</blockquote>
<p>相对于 shell 脚本, chef 将基础设施代码化, 更便于维护, 可读性强</p>
<p>当然比起 shell 脚本的&quot;开箱即用&quot;, chef 的配置还是有点复杂的.</p>
<h2 id="安装-chef">安装 chef</h2>
<p>这里要安装的其实是 <a href="http://downloads.chef.io/chef-dk/">chef-dk</a> (chef开发环境)</p>
<p>选择对应的版本安装后, 你就拥有了下面的这些命令.</p>
<p>东西有点多, 不过下面一边做一边看很快就能理解了.</p>
<h2 id="编写-cookbook">编写 cookbook</h2>
<p>cookbook 就是......菜谱, 简单来说, 执行 cookbook 就相当于对目标机器进行了一次配置.</p>
<h3 id="新建-cookbook">新建 cookbook</h3>
<pre class="shell-script"><code>  berks cookbook rubyist
</code></pre>
<p>运行上面的命令后, 就会生成下面的文件结构</p>
<pre class="shell-script"><code>  .
  ├── attributes
  ├── CHANGELOG.md
  ├── chef-pkgs
  │   ├── chef-12.0.3-1.x86_64.rpm
  │   └── install.sh
  ├── definitions
  ├── files
  │   └── default
  │       └── motd
  ├── Gemfile
  ├── Gemfile.lock
  ├── libraries
  ├── metadata.rb
  ├── providers
  ├── README.md
  ├── recipes
  │   └── default.rb
  ├── resources
  ├── templates
  │   └── default
  └── test
      └── integration
              └── default

</code></pre>
<p>这样我们就有了一个 cookbook 的骨架.</p>
<h3 id="确定需求">确定需求</h3>
<p>一个常见的 rubyist 的开发环境包含但不限于:</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">种类</th>
<th style="text-align: left;">内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">ruby</td>
<td style="text-align: left;">ruby 语言及其生态环境</td>
</tr>
<tr class="even">
<td style="text-align: left;">vcs</td>
<td style="text-align: left;">版本控制工具 git svn 等</td>
</tr>
<tr class="odd">
<td style="text-align: left;">editor</td>
<td style="text-align: left;">编辑器 emacs vim 等</td>
</tr>
<tr class="even">
<td style="text-align: left;">database</td>
<td style="text-align: left;">数据库 sqlite mysql postgresql 等</td>
</tr>
<tr class="odd">
<td style="text-align: left;">misc</td>
<td style="text-align: left;">dotfiles and libs</td>
</tr>
</tbody>
</table>
<h3 id="编写-recipe">编写 recipe</h3>
<p>cookbook 就是 recipe 的集合, 一个 recipe 代表一个配置项</p>
<p>所以不难得出 rubyist 的几个 recipe</p>
<ul>
<li>default</li>
<li>user</li>
<li>ruby</li>
<li>vcs</li>
<li>editor</li>
<li>database</li>
</ul>
<h3 id="测试-cookbook">测试 cookbook</h3>
<p>刚才新建的 cookbook 里有一个 .kitchen.yml 文件</p>
<p>kitchen 是一个 chef 的测试框架</p>
<p>kitchen 默认使用 <a href="https://www.vagrantup.com/">vagrant</a> 作为 provider</p>
<p>kitchen 提供了一个沙盒测试环境, 配置 .kitchen.yml 文件后, 执行</p>
<pre class="shell-script"><code>kitchen converge
</code></pre>
<p>就可以执行 cookbook 了, 然后可以使用</p>
<p>kitchen login 进入虚拟机, 检测执行结果（由于基础设置即代码， 所以 cookbook 是可以用代码来测试的）</p>
<h3 id="使用-cookbook">使用 cookbook</h3>
<p>无论是用高大上的单元测试还是简单的手动测试， 总之你要使用自己的 cookbook 了。 这里我使用 vagrant 新建一个虚拟机来作为开发环境， 对于 vagrant， 可以安装一些插件来方便调用chef 下面是我安装的插件</p>
<ul>
<li>vagrant-berkshelf (4.0.2)</li>
<li>vagrant-hostmanager (1.5.0)</li>
<li>vagrant-hostsupdater (0.0.11)</li>
<li>vagrant-omnibus (1.4.1)</li>
<li>vagrant-share (1.1.3, system)</li>
</ul>
<p>其中 omnibus 可以确保 box 中 chef 已经被安装了。berkshelf 是用来读取 workstation 上用 berkshelf 管理的 cookbook 的。 在 Vagrant 的配置文件中加入对 chef 的支持。</p>
<pre class="ruby"><code>  config.berkshelf.berksfile_path = &quot;./cookbooks/rubyist/Berksfile&quot;
  config.berkshelf.enabled = true
  config.vm.provision &quot;chef_solo&quot; do |chef|
    chef.log_level = :debug
    chef.add_recipe &quot;rubyist&quot;
  end

</code></pre>
<p>这样使用 <code>vagrant provision</code> 就会执行你编写的cookbook了。</p>
<h3 id="tips">tips</h3>
<h4 id="git-操作非常慢">git 操作非常慢</h4>
<p>如果发现共享的文件夹在执行git命令的时候非常的慢, 可以这样做</p>
<ol>
<li>vagrantfile 中启用 nfs</li>
</ol>
<pre class="ruby"><code>  config.vm.synced_folder &quot;.&quot;, &quot;/vagrant&quot;, type: &quot;nfs&quot;
</code></pre>
<ol>
<li>在项目下执行git prune 和 git gc</li>
</ol>
<p>可以有效提升性能</p>
<h4 id="配置本地的自定义域名访问虚拟机">配置本地的自定义域名访问虚拟机</h4>
<p>只需要在 <code>Vagrantfile</code> 里配置</p>
<pre class="ruby"><code>  config.vm.network &quot;private_network&quot;, ip: &quot;33.33.33.10&quot;
  config.vm.hostname = &quot;ubox&quot;
  config.hostsupdater.aliases = [&quot;m.dyne.dev&quot;, &quot;pc.dyne.dev&quot;]
</code></pre>
<h4 id="安装本地的-chef-安装包-天朝必备">安装本地的 chef 安装包 （天朝必备）</h4>
<p>只需要在 <code>Vagrantfile</code> 里配置</p>
<pre class="ruby"><code>  config.vm.synced_folder &quot;./cookbooks/rubyist/chef-pkgs&quot;, &quot;/tmp/chef-pkgs&quot;, type: &quot;nfs&quot;
  config.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL
    sudo dpkg -i /tmp/chef-pkgs/chef_12.0.3-1_amd64.deb
  SHELL
  # 要在 chef_solo 的配置前面
</code></pre>

</article>

      </div>
    </main> <!-- 网页主体 -->

    <!-- 评论框 -->

    <footer role="contentinfo" class="global-footer row">
      <p class="copyright">© Ma Lucheng 2014-2015 — All content is licensed under the
        <a href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons BY-SA 3.0</a>.
      </p>

      <figure class="footer-zfm">
        <img src="http://javaer.qiniudn.com/zhifuma.png" alt="支付宝二维码" />
        <figcaption>觉得文章对你有帮助，可以打赏一杯咖啡支持一下</figcaption>
      </figure>
    </footer><!-- 页脚 -->

    <script src="/js/vendor.js"></script>
    <script src="/js/app.js"></script>
    <script src="//cdn.bootcss.com/highlight.js/8.9.1/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script>require('main').init();</script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-68587267-1', 'auto');
      ga('send', 'pageview');
    </script>

    <script src="//cdn.bootcss.com/instantclick/3.0.1/instantclick.min.js"></script>
    <script>
      InstantClick.on('change', function() {
        var blocks = document.querySelectorAll('pre code');
        for (var i = 0; i < blocks.length; i++) {
          hljs.highlightBlock(blocks[i]);
        }
      });
    </script>

    <script type="text/javascript" src=""></script>
  </body>
</html>
